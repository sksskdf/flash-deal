# Product 도메인 모델 상세

## 2. 스키마

### 2.1 기본 구조
```javascript
{
  _id: ObjectId("65a1b2c3d4e5f6789abcdef0"),
  dealType: "flash",  // 핵심 식별자
  
  // === 공통 필드 (모든 딜 타입) ===
  title: "무선 노이즈 캔슬링 헤드폰",
  subtitle: "프리미엄 오디오 경험",
  description: "액티브 노이즈 캔슬링과 30시간 배터리...",
  category: "전자기기",
  
  images: [
    "https://cdn.example.com/products/headphone-main.jpg",
    "https://cdn.example.com/products/headphone-side.jpg"
  ],
  
  // === 가격 정보 ===
  price: {
    original: 299.00,
    sale: 89.00,
    currency: "USD",
    rate: 70  // (original - sale) / original * 100
  },
  
  // === 일정 정보 ===
  schedule: {
    startsAt: ISODate("2025-10-13T09:00:00Z"),
    endsAt: ISODate("2025-10-13T12:00:00Z"),
    timezone: "Asia/Seoul"
  },
  
  // === 상태 (계산됨 - 별도 업데이트 프로세스) ===
  status: "active",  // upcoming | active | soldout | ended
  
  // === 동적 속성 (완전 자유 형식) ===
  specs: {
    // 이 필드는 상품마다 완전히 다름!
  },
  
  // === 메타데이터 (비즈니스 요구사항) ===
  metadata: {
    featured: true,
    tags: ["bestseller", "premium"],
    vendor: "AudioTech Inc.",
    sku: "AT-WH-1000XM5",
    // 언제든 추가 가능
  },
  
  createdAt: ISODate("2025-10-01T00:00:00Z"),
  updatedAt: ISODate("2025-10-13T08:00:00Z")
}
```



## 3. 동적 속성(specs) 예시

### 3.1 전자기기
```javascript
{
  _id: ObjectId("..."),
  title: "4K 스마트 TV 55\"",
  category: "전자기기",
  specs: {
    display: {
      size: "55 inch",
      resolution: "3840x2160",
      panelType: "OLED",
      hdr: ["HDR10", "HDR10+", "Dolby Vision"]
    },
    connectivity: {
      hdmi: 4,
      usb: 3,
      wifi: "Wi-Fi 6",
      bluetooth: "5.0"
    },
    smart: {
      os: "webOS 23",
      voiceControl: ["Google Assistant", "Alexa"],
      apps: ["Netflix", "YouTube", "Disney+"]
    },
    power: {
      consumption: "120W",
      standby: "0.5W"
    },
    dimensions: {
      withStand: "123 x 78 x 25 cm",
      withoutStand: "123 x 71 x 5 cm",
      weight: "18.5 kg"
    }
  }
}
```

### 3.2 의류
```javascript
{
  _id: ObjectId("..."),
  title: "프리미엄 코튼 티셔츠",
  category: "패션",
  specs: {
    material: {
      primary: "Cotton 100%",
      origin: "Organic Turkish Cotton",
      certifications: ["GOTS", "Oeko-Tex"]
    },
    sizes: [
      {
        size: "S",
        measurements: {
          chest: "96 cm",
          length: "68 cm",
          shoulder: "44 cm"
        },
        inStock: true
      },
      {
        size: "M",
        measurements: {
          chest: "101 cm",
          length: "70 cm",
          shoulder: "46 cm"
        },
        inStock: true
      }
    ],
    colors: [
      { name: "Black", hex: "#000000", available: true },
      { name: "White", hex: "#FFFFFF", available: true },
      { name: "Navy", hex: "#001F3F", available: false }
    ],
    care: {
      washing: "Machine wash cold",
      drying: "Tumble dry low",
      ironing: "Medium heat",
      bleach: "Do not bleach"
    },
    fit: "Regular fit",
    style: "Crew neck"
  }
}
```

### 3.3 식품
```javascript
{
  _id: ObjectId("..."),
  title: "유기농 코코아 파우더",
  category: "식품",
  specs: {
    nutrition: {
      servingSize: "10g",
      calories: 35,
      protein: "2g",
      carbs: "5g",
      fat: "1g",
      fiber: "3g"
    },
    ingredients: [
      "Organic Cocoa Powder",
      "Organic Cane Sugar (optional)"
    ],
    allergens: ["May contain traces of milk"],
    certifications: ["USDA Organic", "Fair Trade", "Non-GMO"],
    storage: {
      temperature: "Cool, dry place",
      shelfLife: "24 months",
      afterOpening: "Use within 6 months"
    },
    origin: {
      country: "Ecuador",
      region: "Guayas Province",
      producer: "Fair Trade Cooperative"
    },
    packaging: {
      type: "Resealable pouch",
      material: "Recyclable aluminum",
      weight: "500g"
    }
  }
}
```



## 4. 메타데이터 확장 예시

### 4.1 마케팅 메타데이터
```javascript
{
  metadata: {
    // 기본 필드
    featured: true,
    tags: ["new-arrival", "eco-friendly"],
    vendor: "GreenTech",
    sku: "GT-ECO-2024",
    
    // 마케팅 팀이 추가한 필드 (언제든 가능!)
    campaign: {
      name: "Green Friday 2024",
      trackingCode: "GF2024-ECO",
      affiliateId: "partner-123"
    },
    seo: {
      metaTitle: "Buy Eco-Friendly Headphones | 70% Off",
      metaDescription: "Premium noise-cancelling...",
      keywords: ["eco headphones", "sustainable audio"]
    },
    
    // A/B 테스트 팀이 추가한 필드
    experiments: {
      variant: "priceB",
      testGroup: "control",
      exposureTime: ISODate("2025-10-13T00:00:00Z")
    },
    
    // 운영 팀이 추가한 필드
    internal: {
      purchaseCost: 45.00,
      margin: 49.4,  // percentage
      supplier: "TechWholesale Inc.",
      warehouse: "Seoul-01"
    }
  }
}
```

### 4.2 AI/ML 메타데이터
```javascript
{
  metadata: {
    // 추천 시스템이 추가한 필드
    ml: {
      embeddings: [0.123, -0.456, 0.789, ...],  // 벡터
      category_confidence: 0.95,
      similar_products: [
        ObjectId("..."),
        ObjectId("...")
      ],
      predicted_popularity: 8.5
    },
    
    // 가격 최적화 시스템
    pricing: {
      dynamic_price_enabled: true,
      price_floor: 79.00,
      price_ceiling: 99.00,
      optimal_price: 89.00,
      last_optimization: ISODate("...")
    }
  }
}
```



## 5. DealType별 추가 필드

### 5.1 Flash Deal (기본)
```javascript
{
  dealType: "flash",
  
  // Flash Deal 특화 필드 없음
  // schedule과 재고만으로 충분
  
  metadata: {
    flashDeal: {
      priority: 1,  // 홈페이지 노출 우선순위
      notificationSent: true
    }
  }
}
```

### 5.2 Time Deal (시간대별 가격)
```javascript
{
  dealType: "time",
  
  // 기본 price는 현재 가격
  price: {
    original: 299.00,
    sale: 89.00,  // 현재 시간대 가격
    currency: "USD",
    rate: 70
  },
  
  // Time Deal 특화 필드
  priceSchedule: [
    {
      timeRange: { start: "00:00", end: "12:00" },
      price: { sale: 99.00, rate: 67 }
    },
    {
      timeRange: { start: "12:00", end: "18:00" },
      price: { sale: 89.00, rate: 70 }
    },
    {
      timeRange: { start: "18:00", end: "24:00" },
      price: { sale: 79.00, rate: 74 }
    }
  ],
  
  metadata: {
    timeDeal: {
      currentSlot: 1,  // 현재 슬롯 인덱스
      nextPriceChange: ISODate("2025-10-13T18:00:00Z")
    }
  }
}
```

### 5.3 Group Buy Deal
```javascript
{
  dealType: "group",
  
  // 기본 price는 최대 할인 가격
  price: {
    original: 299.00,
    sale: 69.00,  // 최대 할인 적용 시
    currency: "USD",
    rate: 77
  },
  
  // Group Buy 특화 필드
  groupBuy: {
    minParticipants: 10,
    maxParticipants: 100,
    currentParticipants: 47,
    
    discountTiers: [
      { threshold: 10, discountRate: 20, price: 239.00 },
      { threshold: 30, discountRate: 30, price: 209.00 },
      { threshold: 50, discountRate: 40, price: 179.00 },
      { threshold: 100, discountRate: 50, price: 149.00 }
    ],
    
    currentTier: {
      threshold: 30,
      discountRate: 30,
      price: 209.00,
      nextTierAt: 50
    }
  },
  
  metadata: {
    groupBuy: {
      participants: [
        { userId: "user123", joinedAt: ISODate("...") },
        { userId: "user456", joinedAt: ISODate("...") }
        // ... (실제로는 별도 컬렉션 권장)
      ],
      status: "in_progress"  // in_progress | success | failed
    }
  }
}
```



## 6. 상태 관리

### 6.1 상태 전환 규칙
```javascript
// 상태 계산 로직 (scheduled job or reactive)
function calculateStatus(product) {
  const now = new Date();
  
  if (now < product.schedule.startsAt) {
    return "upcoming";
  }
  
  if (now > product.schedule.endsAt) {
    return "ended";
  }
  
  // 재고 확인 (Redis에서)
  const stock = await redis.get(`inventory:${product._id}`);
  if (stock <= 0) {
    return "soldout";
  }
  
  return "active";
}
```

### 6.2 상태 업데이트 전략
```
Option 1: Scheduled Job
- 매분/5분마다 상태 업데이트
- 부하: 낮음, 정확도: 보통

Option 2: Event-Driven
- startsAt/endsAt 시각에 이벤트 발행
- 부하: 낮음, 정확도: 높음

Option 3: On-Demand
- 조회 시마다 계산 (캐싱)
- 부하: 높음, 정확도: 매우 높음

추천: Option 2 (Event-Driven) + 캐싱
```



## 7. 조회 패턴과 인덱스

### 7.1 주요 조회 패턴
```javascript
// 1. 진행중인 딜 목록
db.products.find({
  status: "active",
  "schedule.endsAt": { $gt: new Date() }
}).sort({ "schedule.startsAt": 1 })

// 2. 카테고리별 딜
db.products.find({
  category: "전자기기",
  status: "active"
}).sort({ "price.rate": -1 })  // 할인율 높은순

// 3. 예정된 딜 (알림용)
db.products.find({
  status: "upcoming",
  "schedule.startsAt": {
    $gte: new Date(),
    $lte: new Date(Date.now() + 24*60*60*1000)  // 24시간 이내
  }
})

// 4. Featured 딜
db.products.find({
  "metadata.featured": true,
  status: "active"
}).limit(10)

// 5. 동적 속성 검색 (예: OLED TV)
db.products.find({
  category: "전자기기",
  "specs.display.panelType": "OLED"
})
```

### 7.2 인덱스 전략
```javascript
// 복합 인덱스 (가장 빈번한 쿼리)
db.products.createIndex({
  status: 1,
  "schedule.startsAt": 1
})

// 카테고리 + 상태
db.products.createIndex({
  category: 1,
  status: 1,
  "price.rate": -1
})

// Featured 딜
db.products.createIndex({
  "metadata.featured": 1,
  status: 1
})

// Deal Type별
db.products.createIndex({
  dealType: 1,
  status: 1
})

// 전체 텍스트 검색 (선택)
db.products.createIndex({
  title: "text",
  description: "text",
  category: "text"
}, {
  weights: {
    title: 10,
    category: 5,
    description: 1
  }
})

// 동적 속성 검색 (주의: 너무 많으면 성능 저하)
// 필요시 특정 필드에만 인덱스
db.products.createIndex({
  "specs.display.panelType": 1
})
```



## 8. 스키마 검증

### 8.1 MongoDB Schema Validation
```javascript
db.createCollection("products", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: [
        "dealType",
        "title",
        "category",
        "price",
        "schedule",
        "status"
      ],
      properties: {
        dealType: {
          enum: ["flash", "time", "group"],
          description: "딜 타입은 필수이며 정해진 값만 가능"
        },
        title: {
          bsonType: "string",
          minLength: 1,
          maxLength: 200
        },
        price: {
          bsonType: "object",
          required: ["original", "sale", "currency"],
          properties: {
            original: {
              bsonType: "number",
              minimum: 0
            },
            sale: {
              bsonType: "number",
              minimum: 0
            },
            currency: {
              bsonType: "string",
              enum: ["USD", "KRW", "EUR", "JPY"]
            },
            rate: {
              bsonType: "number",
              minimum: 0,
              maximum: 100
            }
          }
        },
        schedule: {
          bsonType: "object",
          required: ["startsAt", "endsAt"],
          properties: {
            startsAt: { bsonType: "date" },
            endsAt: { bsonType: "date" }
          }
        },
        status: {
          enum: ["upcoming", "active", "soldout", "ended"]
        },
        images: {
          bsonType: "array",
          items: { bsonType: "string" }
        },
        // specs와 metadata는 완전 자유 형식
        specs: {
          bsonType: "object"
          // 내부 구조 검증 안 함!
        },
        metadata: {
          bsonType: "object"
          // 내부 구조 검증 안 함!
        }
      }
    }
  },
  validationLevel: "moderate",  // 기존 문서 제외
  validationAction: "warn"      // 실패 시 경고 (reject 아님)
})
```



## 9. 마이그레이션 시나리오

### 9.1 새 필드 추가 (무중단)
```javascript
// 예: 비디오 추가
db.products.updateMany(
  { category: "전자기기" },
  {
    $set: {
      "metadata.videos": []
    }
  }
)

// 기존 문서는 videos 없어도 됨 (스키마 유연성)
// 애플리케이션 코드에서 null-safe 처리
```

### 9.2 필드 타입 변경
```javascript
// 예: tags가 String에서 Array로
db.products.updateMany(
  {
    "metadata.tags": { $type: "string" }
  },
  [{
    $set: {
      "metadata.tags": {
        $split: ["$metadata.tags", ","]
      }
    }
  }]
)
```

### 9.3 다형성 필드 추가
```javascript
// Time Deal에 priceSchedule 추가
db.products.updateMany(
  { dealType: "time", priceSchedule: { $exists: false } },
  {
    $set: {
      priceSchedule: [
        {
          timeRange: { start: "00:00", end: "24:00" },
          price: { sale: "$price.sale", rate: "$price.rate" }
        }
      ]
    }
  }
)
```



## 10. Best Practices

### 10.1 DO
✅ specs와 metadata는 완전히 자유롭게 사용
✅ 카테고리별로 다른 specs 구조 허용
✅ 비즈니스 요구사항에 따라 metadata 즉시 확장
✅ dealType으로 다형성 구현
✅ 상태는 계산값으로 관리 (eventual consistency)

### 10.2 DON'T
❌ specs 내부에 공통 필드 강제하지 말 것
❌ metadata 스키마 미리 정의하지 말 것
❌ 모든 필드에 인덱스 생성 (성능 저하)
❌ 관계형 DB처럼 정규화하지 말 것
❌ 동적 필드에 스키마 검증 적용

### 10.3 성능 고려사항
- specs 깊이는 3-4 레벨 이내 권장
- 배열 필드 크기는 100개 이하 권장
- 임베디드 문서 크기는 16MB 이내 (MongoDB 제한)
- 자주 변경되는 필드(상태)는 별도 업데이트 프로세스