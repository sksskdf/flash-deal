# Kafka 이벤트 설계

## Topic 구조
```
orders.created          → 주문 생성
orders.updated          → 주문 상태 변경
orders.cancelled        → 주문 취소
orders.completed        → 주문 완료

payments.pending        → 결제 대기
payments.completed      → 결제 완료
payments.failed         → 결제 실패
payments.refunded       → 환불 완료

inventory.reserved      → 재고 예약
inventory.released      → 재고 해제
inventory.confirmed     → 재고 확정

notifications.email     → 이메일 알림
notifications.push      → 푸시 알림
notifications.sms       → SMS 알림
```

## 이벤트 스키마

### OrderCreated
```javascript
{
  eventId: "evt-65a1b2c3d4e5f6789abcdef0",  // 멱등성
  eventType: "OrderCreated",
  eventVersion: "1.0",
  timestamp: "2025-10-13T10:30:00Z",
  
  // 주문 정보
  order: {
    orderId: "65a1b2c3d4e5f6789abcdef0",
    orderNumber: "FD-20251013-A7B3C9",
    userId: "user123",
    
    items: [
      {
        productId: "65a1b2c3d4e5f6789abcdef1",
        quantity: 2,
        unitPrice: 89.00
      }
    ],
    
    total: 187.99,
    currency: "USD"
  },
  
  // 메타데이터
  metadata: {
    source: "web",
    correlationId: "corr-123",  // 분산 추적
    causationId: "cause-456"    // 원인 이벤트
  }
}
```

### PaymentCompleted
```javascript
{
  eventId: "evt-...",
  eventType: "PaymentCompleted",
  eventVersion: "1.0",
  timestamp: "2025-10-13T10:30:15Z",
  
  payment: {
    orderId: "65a1b2c3d4e5f6789abcdef0",
    amount: 187.99,
    currency: "USD",
    method: "card",
    transactionId: "pi_3O1K2lJKLMNOPQRS",
    gateway: "Stripe"
  },
  
  metadata: {
    correlationId: "corr-123"
  }
}
```

### InventoryReserved
```javascript
{
  eventId: "evt-...",
  eventType: "InventoryReserved",
  eventVersion: "1.0",
  timestamp: "2025-10-13T10:30:01Z",
  
  inventory: {
    productId: "65a1b2c3d4e5f6789abcdef1",
    quantity: 2,
    orderId: "65a1b2c3d4e5f6789abcdef0",
    expiresAt: "2025-10-13T10:40:00Z"  // 10분 후
  }
}
```

# 멱등성 처리

## Idempotency Key
```javascript
// 클라이언트 생성
const idempotencyKey = `idem-${userId}-${timestamp}-${randomString}`;

// GraphQL Mutation
mutation CreateOrder {
  createOrder(
    input: { ... }
    idempotencyKey: "idem-user123-1697184600-abc"
  ) {
    orderId
    status
  }
}

// 서버 검증
async function createOrder(input, idempotencyKey) {
  const existing = await db.orders.findOne({ idempotencyKey });
  
  if (existing) {
    // 이미 처리된 요청
    return {
      orderId: existing._id,
      status: existing.status,
      isDuplicate: true
    };
  }
  
  // 새 주문 생성
  const order = await db.orders.insertOne({
    ...input,
    idempotencyKey,
    status: "pending"
  });
  
  return {
    orderId: order._id,
    status: "pending",
    isDuplicate: false
  };
}
```

## Kafka 이벤트 멱등성
```javascript
// Producer: eventId로 중복 방지
const eventId = `evt-${orderId}-OrderCreated`;

await kafka.send({
  topic: 'orders.created',
  key: orderId,  // 파티션 키
  value: {
    eventId,  // 멱등성 키
    eventType: 'OrderCreated',
    // ...
  }
});

// Consumer: eventId 확인
async function handleOrderCreated(event) {
  const processed = await db.processed_events.findOne({
    eventId: event.eventId
  });
  
  if (processed) {
    console.log('Event already processed:', event.eventId);
    return;  // 중복 처리 스킵
  }
  
  // 처리
  await processOrder(event.order);
  
  // 처리 완료 기록
  await db.processed_events.insertOne({
    eventId: event.eventId,
    processedAt: new Date()
  });
}
```