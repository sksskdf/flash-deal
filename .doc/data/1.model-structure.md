# Product
```javascript
{
  _id: ObjectId("65a1b2c3d4e5f6789abcdef0"),
  dealType: "flash",  // 핵심 식별자
  // === 공통 필드 (모든 딜 타입) ===
  title: "무선 노이즈 캔슬링 헤드폰",
  subtitle: "프리미엄 오디오 경험",
  description: "액티브 노이즈 캔슬링과 30시간 배터리...",
  category: "전자기기",
  images: ["https://cdn.example.com/products/headphone-main.jpg", "https://cdn.example.com/products/headphone-side.jpg"],
  // === 가격 정보 ===
  price: {
    original: 299.00,
    sale: 89.00,
    currency: "USD",
    rate: 70  // (original - sale) / original * 100
  },
  // === 일정 정보 ===
  schedule: {
    startsAt: ISODate("2025-10-13T09:00:00Z"),
    endsAt: ISODate("2025-10-13T12:00:00Z"),
    timezone: "Asia/Seoul"
  },
  // === 상태 (계산됨 - 별도 업데이트 프로세스) ===
  status: "active",  // upcoming | active | soldout | ended
  // === 동적 속성 (완전 자유 형식) ===
  specs: {
    // 이 필드는 상품마다 완전히 다름!
  },
  // === 메타데이터 (비즈니스 요구사항) ===
  metadata: {
    featured: true,
    tags: ["bestseller", "premium"],
    vendor: "AudioTech Inc.",
    sku: "AT-WH-1000XM5",
    // 언제든 추가 가능
  },
  createdAt: ISODate("2025-10-01T00:00:00Z"),
  updatedAt: ISODate("2025-10-13T08:00:00Z")
}
```

## 인덱스
```javascript
{ status: 1, "schedule.startsAt": 1 }
{ category: 1, status: 1, "price.rate": -1 }
{ "metadata.featured": 1, status: 1 }
{ dealType: 1, status: 1 }
{ title: "text", description: "text", category: "text" }, 
{ weights: { title: 10, category: 5, description: 1 } }
// 동적 속성 검색 (주의: 너무 많으면 성능 저하)
// 필요시 특정 필드에만 인덱스
{ "specs.display.panelType": 1 }
```

## 스키마 검증
```javascript
{
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["dealType", "title", "category", "price", "schedule", "status"],
      properties: {
        dealType: { enum: ["flash", "time", "group"], description: "딜 타입은 필수이며 정해진 값만 가능" },
        title: { bsonType: "string", minLength: 1, maxLength: 200 },
        price: {
          bsonType: "object",
          required: ["original", "sale", "currency"],
          properties: {
            original: { bsonType: "number", minimum: 0 },
            sale: { bsonType: "number", minimum: 0 },
            currency: { bsonType: "string", enum: ["USD", "KRW", "EUR", "JPY"] },
            rate: { bsonType: "number", minimum: 0, maximum: 100 }
          }
        },
        schedule: {
          bsonType: "object",
          required: ["startsAt", "endsAt"],
          properties: {
            startsAt: { bsonType: "date" },
            endsAt: { bsonType: "date" }
          }
        },
        status: { enum: ["upcoming", "active", "soldout", "ended"] },
        images: { bsonType: "array", items: { bsonType: "string" } },
        // specs와 metadata는 완전 자유 형식
        specs: { bsonType: "object" },
        metadata: { bsonType: "object" }
      }
    }
  },
  validationLevel: "moderate",  // 기존 문서 제외
  validationAction: "warn"      // 실패 시 경고 (reject 아님)
}
```

# Inventory
```javascript
{
  _id: ObjectId("65a1b2c3d4e5f6789abcdef0"),
  productId: ObjectId("..."),  // Product 참조
  
  // === 재고 수량 (Redis와 동기화) ===
  stock: {
    total: 1000,           // 총 재고 (초기값)
    reserved: 47,          // 예약된 재고 (pending orders)
    available: 953,        // 가용 재고 (total - reserved)
    sold: 0                // 판매 완료 수량
  },
  
  // === UI 표시용 재고 상태 레벨 ===
  level: "high",  // high (≥50%) | mid (20-50%) | low (<20%)
  
  // === Redis 연동 정보 ===
  redis: {
    key: "inventory:65a1b2c3d4e5f6789abcdef0",
    currentValue: 953,     // 현재 Redis 값
    lastSyncedAt: ISODate("2025-10-13T10:30:00Z"),
    syncVersion: 15        // 낙관적 락 버전
  },
  
  // === 재고 정책 ===
  policy: {
    // 안전 재고 (품절 임박 알림용)
    safetyStock: 50,
    
    // 재입고 정책
    restock: {
      enabled: true,
      threshold: 10,        // 이하로 떨어지면 재입고 요청
      quantity: 500,        // 재입고 수량
      supplier: "TechSupplier Co."
    },
    
    // 예약 시간 제한
    reservationTimeout: 600,  // 10분 (초)
    
    // 동적 필드 (향후 추가 가능)
    maxPurchasePerUser: 5,
    bulkDiscountThreshold: 10
  },
  
  // === 임계값 설정 (level 계산용) ===
  thresholds: {
    high: 0.5,    // 50% 이상
    mid: 0.2,     // 20% 이상
    low: 0.0      // 20% 미만
  },
  
  // === 이벤트 로그 (선택적, 분석용) ===
  events: [
    {
      type: "decrease",      // increase | decrease | reserve | release | sync
      amount: 1,
      before: 954,
      after: 953,
      reason: "order_confirmed",
      orderId: ObjectId("..."),
      timestamp: ISODate("2025-10-13T10:29:45Z"),
      
      // 동적 메타데이터
      metadata: {
        userId: "user123",
        source: "web",
        region: "Seoul"
      }
    },
    // ... 최근 100-1000개만 유지 (TTL 인덱스)
  ],
  
  // === 재고 조정 이력 (수동 조정) ===
  adjustments: [
    {
      type: "manual_increase",  // manual_increase | manual_decrease | system_correction
      amount: 100,
      reason: "재입고",
      adjustedBy: "admin@example.com",
      timestamp: ISODate("2025-10-13T09:00:00Z")
    }
  ],
  
  createdAt: ISODate("2025-10-01T00:00:00Z"),
  updatedAt: ISODate("2025-10-13T10:30:00Z")
}
```

## 인덱스

```javascript
// Inventory 컬렉션
{ productId: 1 }, { unique: true }
{ 'redis.key': 1 }
{ level: 1 }
{ 'stock.available': 1 }

// Events (별도 컬렉션인 경우)
{ productId: 1, timestamp: -1 }
{ type: 1, timestamp: -1 }
```

## 스키마 검증
```javascript
{
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: [
        "productId",
        "stock",
        "level"
      ],
      properties: {
        productId: {
          bsonType: "objectId"
        },
        level: {
          enum: ["high", "mid", "low"]
        },
        stock: {
          bsonType: "object",
          required: ["total", "reserved", "available", "sold"],
          properties: {
            total: {
              bsonType: "number",
              minimum: 0
            },
            reserved: {
              bsonType: "number",
              minimum: 0
            },
            available: {
              bsonType: "number",
              minimum: 0
            },
            sold: {
              bsonType: "number",
              minimum: 0
            }
          }
        },
        "policy.safetyStock": {
          bsonType: "number",
          minimum: 0
        },
        "policy.reservationTimeout": {
          bsonType: "number",
          minimum: 1
        }
      }
    }
  },
  validationLevel: "moderate",  // 기존 문서 제외
  validationAction: "warn"      // 실패 시 경고 (reject 아님)
}
```

# Order
```javascript
{
  _id: ObjectId("65a1b2c3d4e5f6789abcdef0"),
  orderNumber: "FD-20251013-A7B3C9",  // 사용자 친화적 ID
  
  // === 사용자 정보 (비정규화) ===
  user: {
    id: "user123",           // 외부 User ID (인증 시스템)
    email: "user@example.com",
    name: "홍길동",
    phone: "+82-10-1234-5678"  // 동적 추가
  },
  
  // === 주문 상품 (완전 비정규화 - 스냅샷) ===
  items: [
    {
      productId: ObjectId("..."),
      dealType: "flash",     // 주문 시점의 딜 타입
      
      // 주문 시점 스냅샷 (Product 변경돼도 유지)
      snapshot: {
        title: "무선 노이즈 캔슬링 헤드폰",
        subtitle: "프리미엄 오디오 경험",
        image: "https://cdn.example.com/products/headphone.jpg",
        category: "전자기기",
        
        price: {
          original: 299.00,
          sale: 89.00,
          currency: "USD",
          rate: 70
        },
        
        // 주문 시점의 동적 속성
        specs: {
          color: "Black",
          warranty: "2 years",
          // ... 필요한 스펙만 스냅샷
        },
        
        // 주문 시 선택한 옵션
        selectedOptions: {
          color: "Black",
          warranty: "Extended 3 years (+$20)"
        }
      },
      
      quantity: 2,
      unitPrice: 89.00,
      subtotal: 178.00,  // quantity * unitPrice
      
      // 개별 상품 상태 (선택)
      status: "confirmed",  // pending | confirmed | shipped | cancelled
      
      // 배송 추적 (선택)
      tracking: {
        carrier: "UPS",
        trackingNumber: "1Z999AA10123456784",
        shippedAt: ISODate("2025-10-14T00:00:00Z"),
        estimatedDelivery: ISODate("2025-10-17T00:00:00Z")
      }
    }
  ],
  
  // === 주문 금액 ===
  pricing: {
    subtotal: 178.00,       // items 합계
    shipping: 9.99,
    tax: 0.00,
    discount: 0.00,         // 쿠폰, 프로모션
    total: 187.99,          // 최종 금액
    currency: "USD",
    
    // 동적 추가 가능
    breakdown: {
      productTotal: 178.00,
      shippingBase: 9.99,
      shippingDiscount: 0.00,
      couponDiscount: 0.00,
      pointsUsed: 0.00
    }
  },
  
  // === 배송 정보 ===
  shipping: {
    method: "standard",  // standard | express | overnight
    
    recipient: {
      name: "홍길동",
      phone: "+82-10-1234-5678"
    },
    
    address: {
      type: "home",  // home | office | other
      street: "123 Main St",
      street2: "Apt 4B",
      city: "Seoul",
      state: "Seoul",
      zipCode: "12345",
      country: "KR",
      
      // 동적 추가
      coordinates: {
        lat: 37.5665,
        lng: 126.9780
      }
    },
    
    instructions: "문 앞에 놔주세요",  // 동적 추가
    preferredTime: "오후 2-6시"      // 동적 추가
  },
  
  // === 결제 정보 ===
  payment: {
    method: "card",  // card | paypal | bank_transfer | crypto
    
    // 카드 정보 (마스킹)
    card: {
      last4: "1234",
      brand: "Visa",
      expiryMonth: 12,
      expiryYear: 2025
    },
    
    status: "completed",  // pending | processing | completed | failed | refunded
    
    // 결제 게이트웨이 정보
    gateway: {
      provider: "Stripe",
      transactionId: "pi_3O1K2lJKLMNOPQRS",
      receiptUrl: "https://stripe.com/receipts/...",
      chargedAt: ISODate("2025-10-13T10:30:15Z")
    },
    
    // 환불 정보 (선택)
    refund: {
      amount: 0.00,
      reason: null,
      refundedAt: null,
      transactionId: null
    },
    
    // 동적 추가 (예: 할부)
    installment: {
      months: 3,
      monthlyAmount: 62.66,
      interestRate: 0.0
    }
  },
  
  // === 주문 상태 ===
  status: "confirmed",  // pending | processing | confirmed | shipped | delivered | cancelled | failed
  
  // === 상태 변경 이력 (Event Sourcing) ===
  statusHistory: [
    {
      from: null,
      to: "pending",
      timestamp: ISODate("2025-10-13T10:30:00Z"),
      reason: "Order created",
      actor: "system",
      
      // 동적 메타데이터
      metadata: {
        source: "web",
        ip: "192.168.1.1",
        userAgent: "Mozilla/5.0..."
      }
    },
    {
      from: "pending",
      to: "processing",
      timestamp: ISODate("2025-10-13T10:30:05Z"),
      reason: "Payment processing started",
      actor: "payment-service",
      metadata: {
        paymentMethod: "card",
        processor: "Stripe"
      }
    },
    {
      from: "processing",
      to: "confirmed",
      timestamp: ISODate("2025-10-13T10:30:15Z"),
      reason: "Payment completed",
      actor: "payment-service",
      metadata: {
        transactionId: "pi_3O1K2lJKLMNOPQRS"
      }
    }
  ],
  
  // === Kafka 이벤트 추적 ===
  kafkaEvents: [
    {
      eventType: "OrderCreated",
      topic: "orders.created",
      partition: 2,
      offset: 12345,
      publishedAt: ISODate("2025-10-13T10:30:01Z"),
      
      // 이벤트 페이로드 (선택)
      payload: {
        orderId: "65a1b2c3d4e5f6789abcdef0",
        userId: "user123",
        total: 187.99
      }
    },
    {
      eventType: "PaymentCompleted",
      topic: "payments.completed",
      partition: 1,
      offset: 67890,
      publishedAt: ISODate("2025-10-13T10:30:16Z")
    }
  ],
  
  // === 멱등성 키 ===
  idempotencyKey: "idem-user123-1697184600-abc",  // 중복 주문 방지
  
  // === 취소/환불 정보 ===
  cancellation: {
    isCancelled: false,
    reason: null,
    cancelledBy: null,  // user | admin | system
    cancelledAt: null,
    
    // 부분 취소 (선택)
    items: []
  },
  
  // === 메타데이터 (동적 확장) ===
  metadata: {
    source: "web",           // web | mobile | api
    device: "desktop",
    campaign: "flash-deal-oct",
    referrer: "https://ads.google.com/...",
    
    // A/B 테스트
    experiments: {
      checkoutFlow: "variant-B",
      pricingDisplay: "control"
    },
    
    // 고객 세그먼트
    customerSegment: "VIP",
    loyaltyPoints: 1000,
    
    // 향후 추가 가능한 필드들...
    giftMessage: "Happy Birthday!",
    giftWrap: true,
    
    // 재고 예약 정보
    reservation: {
      reservedAt: ISODate("2025-10-13T10:30:00Z"),
      expiresAt: ISODate("2025-10-13T10:40:00Z"),
      released: false
    }
  },
  
  createdAt: ISODate("2025-10-13T10:30:00Z"),
  updatedAt: ISODate("2025-10-13T10:30:15Z")
}
```

## 인덱스
```javascript
{ "user.id": 1, createdAt: -1 }
{ orderNumber: 1 }, { unique: true }
{ status: 1, "payment.status": 1, createdAt: -1 }
{ "items.productId": 1 }
{ idempotencyKey: 1 }, { unique: true, sparse: true }
{ "kafkaEvents.eventType": 1 }
```

## 스키마 검증
```javascript
{
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: [
        "orderNumber",
        "user",
        "items",
        "pricing",
        "status"
      ],
      properties: {
        orderNumber: {
          bsonType: "string",
          minLength: 1,
          maxLength: 50
        },
        status: {
          enum: ["pending", "processing", "confirmed", "shipped", "delivered", "cancelled", "failed"]
        },
        "payment.status": {
          enum: ["pending", "processing", "completed", "failed", "refunded"]
        },
        pricing: {
          bsonType: "object",
          required: ["subtotal", "shipping", "total", "currency"],
          properties: {
            subtotal: {
              bsonType: "number",
              minimum: 0
            },
            shipping: {
              bsonType: "number",
              minimum: 0
            },
            total: {
              bsonType: "number",
              minimum: 0
            },
            currency: {
              bsonType: "string",
              enum: ["USD", "KRW", "EUR", "JPY"]
            }
          }
        },
        items: {
          bsonType: "array",
          minItems: 1,
          items: {
            bsonType: "object",
            required: ["productId", "quantity", "unitPrice"],
            properties: {
              quantity: {
                bsonType: "number",
                minimum: 1
              },
              unitPrice: {
                bsonType: "number",
                minimum: 0
              }
            }
          }
        }
      }
    }
  },
  validationLevel: "moderate",  // 기존 문서 제외
  validationAction: "warn"      // 실패 시 경고 (reject 아님)
}
```

# 이벤트 로그 관리

## TTL 인덱스
```javascript
// events 배열이 너무 커지지 않도록
db.inventory.createIndex(
  { "events.timestamp": 1 },
  { expireAfterSeconds: 2592000 }  // 30일 후 삭제
)

// 또는 Capped Array (최대 크기 제한)
db.inventory.updateOne(
  { productId },
  {
    $push: {
      events: {
        $each: [newEvent],
        $slice: -1000  // 최근 1000개만 유지
      }
    }
  }
)
```