# 비즈니스 플로우

## 사용자 등록/인증 플로우

### 회원가입
```
1. 사용자: 회원가입 요청
   └→ 이메일, 비밀번호, 이름 입력

2. 서버: 입력 검증
   ├→ 이메일 형식 검증
   ├→ 비밀번호 강도 검증
   └→ 중복 이메일 확인

3. 계정 생성
   ├→ MongoDB: User 문서 생성
   ├→ Redis: 세션 생성
   └→ Kafka: UserRegistered 이벤트 발행

4. 인증 처리
   ├→ JWT 토큰 발급
   ├→ 이메일 인증 링크 발송
   └→ 환영 이메일 발송
```

### 로그인
```
1. 사용자: 로그인 요청
   └→ 이메일, 비밀번호 입력

2. 인증 처리
   ├→ 비밀번호 해시 검증
   ├→ 계정 상태 확인 (활성/비활성)
   └→ 로그인 시도 기록

3. 세션 생성
   ├→ JWT 토큰 발급
   ├→ Redis: 세션 저장
   └→ 응답: 토큰 + 사용자 정보
```

## 상품 탐색/검색 플로우

### 상품 목록 조회
```
1. 사용자: 상품 목록 요청
   └→ GraphQL Query: products(filter, sort, pagination)

2. 서버: 필터링 및 정렬
   ├→ MongoDB: 상품 조회 (인덱스 활용)
   ├→ Redis: 캐시 확인
   └→ 재고 정보 병합

3. 응답 구성
   ├→ 상품 기본 정보
   ├→ 가격 정보
   ├→ 재고 상태
   └→ 페이지네이션 정보
```

### 상품 검색
```
1. 사용자: 검색어 입력
   └→ "무선 헤드폰" 검색

2. 검색 처리
   ├→ 텍스트 인덱스 검색
   ├→ 카테고리 필터링
   ├→ 가격 범위 필터링
   └→ 재고 상태 필터링

3. 결과 반환
   ├→ 검색 결과 목록
   ├→ 관련 상품 추천
   └→ 검색어 자동완성
```

## 장바구니 관리 플로우

### 상품 추가
```
1. 사용자: 장바구니 추가
   └→ GraphQL Mutation: addToCart(productId, quantity)

2. 검증 및 추가
   ├→ 상품 존재 확인
   ├→ 재고 가용성 확인
   ├→ Redis: 장바구니 업데이트
   └→ 응답: 성공/실패

3. 이벤트 발행
   └→ Kafka: CartItemAdded 이벤트
```

### 장바구니 조회
```
1. 사용자: 장바구니 조회
   └→ GraphQL Query: myCart

2. 데이터 조합
   ├→ Redis: 장바구니 아이템
   ├→ MongoDB: 상품 정보 조회
   ├→ 재고 상태 확인
   └→ 가격 계산

3. 응답 구성
   ├→ 장바구니 아이템 목록
   ├→ 총 금액
   ├→ 배송비
   └→ 할인 정보
```

## 주문 처리 플로우

### 주문 생성
```
1. 사용자: 주문 요청
   └→ GraphQL Mutation: createOrder(input, idempotencyKey)

2. 주문 검증
   ├→ 멱등성 키 확인
   ├→ 상품 가용성 확인
   ├→ 배송지 검증
   └→ 결제 정보 검증

3. 주문 생성
   ├→ MongoDB: Order 문서 생성
   ├→ Redis: 재고 예약
   └→ Kafka: OrderCreated 이벤트

4. 응답
   └→ { orderId, status: "pending" }
```

### 결제 처리
```
1. 결제 요청
   ├→ 외부 결제 게이트웨이 호출
   ├→ 카드 정보 토큰화
   └→ 결제 승인 요청

2. 결제 결과 처리
   ├→ 성공 → Kafka: PaymentCompleted
   │  └→ Order.status = "confirmed"
   └→ 실패 → Kafka: PaymentFailed
      └→ 재고 복구 + Order.status = "failed"

3. 알림 발송
   ├→ 결제 완료 이메일
   └→ 주문 확인서 발송
```

## 배송 추적 플로우

### 배송 시작
```
1. 관리자: 배송 처리
   └→ 주문 상태를 "shipped"로 변경

2. 배송 정보 업데이트
   ├→ 택배사 정보 입력
   ├→ 송장번호 생성
   └→ 예상 배송일 계산

3. 고객 알림
   ├→ 배송 시작 SMS
   ├→ 추적 링크 제공
   └→ 예상 도착일 안내
```

### 배송 완료
```
1. 택배사: 배송 완료 알림
   └→ API 웹훅 수신

2. 주문 상태 업데이트
   ├→ Order.status = "delivered"
   ├→ 배송 완료 시간 기록
   └→ Kafka: OrderDelivered 이벤트

3. 후속 처리
   ├→ 구매 확정 알림
   ├→ 리뷰 작성 유도
   └→ 재구매 추천
```

## 고객 서비스 플로우

### 문의 접수
```
1. 고객: 문의 등록
   └→ 문의 유형, 내용 입력

2. 문의 처리
   ├→ MongoDB: 문의 문서 생성
   ├→ 우선순위 할당
   └→ Kafka: CustomerInquiry 이벤트

3. 담당자 배정
   ├→ 문의 유형별 라우팅
   ├→ 담당자 알림
   └→ 응답 SLA 설정
```

### 문의 처리
```
1. 담당자: 문의 확인
   ├→ 문의 내용 검토
   ├→ 관련 주문/상품 조회
   └→ 해결 방안 수립

2. 응답 처리
   ├→ 고객에게 응답
   ├→ 필요시 추가 정보 요청
   └→ 문의 상태 업데이트

3. 완료 처리
   ├→ 고객 만족도 조사
   ├→ 해결 방안 기록
   └→ 지식 베이스 업데이트
```

## 부분 취소/환불
```javascript
{
  _id: ObjectId("..."),
  status: "partially_cancelled",  // 새 상태
  
  items: [
    {
      productId: ObjectId("..."),
      quantity: 2,
      status: "confirmed",  // 정상
      // ...
    },
    {
      productId: ObjectId("..."),
      quantity: 1,
      status: "cancelled",  // 취소됨
      // ...
    }
  ],
  
  cancellation: {
    isCancelled: false,  // 전체는 아님
    isPartial: true,
    
    items: [
      {
        productId: ObjectId("..."),
        quantity: 1,
        reason: "고객 요청",
        cancelledBy: "user",
        cancelledAt: ISODate("..."),
        refundAmount: 89.00
      }
    ],
    
    totalRefund: 89.00
  }
}
```