# 비즈니스 플로우

## 핵심 사용자 플로우

### 1. 상품 탐색 → 구매
```
1. 상품 목록 조회
   └→ GraphQL Query: products(filter, sort, pagination)
   └→ MongoDB 조회 + Redis 캐시 + 재고 정보 병합

2. 상품 상세 조회
   └→ 상품 정보, 가격, 재고 상태, 리뷰 확인

3. 장바구니 추가
   └→ GraphQL Mutation: addToCart(productId, quantity)
   └→ 재고 가용성 확인 + Redis 업데이트

4. 주문 생성
   └→ GraphQL Mutation: createOrder(input, idempotencyKey)
   └→ 멱등성 확인 + 재고 예약 + Kafka 이벤트

5. 결제 처리
   └→ 외부 결제 게이트웨이 호출
   └→ 성공: Order.confirmed / 실패: 재고 복구
```

### 2. 재고 관리 플로우
```
1. 재고 감소 (낙관적)
   └→ Redis DECR inventory:{productId}
   └→ 성공: 주문 생성 / 실패: 품절 응답

2. 재고 예약 (비관적)
   └→ 분산 락 획득 → 재고 확인 → 감소 → 락 해제

3. 재고 확정/해제
   └→ 결제 성공: 예약 → 확정
   └→ 결제 실패/타임아웃: 예약 → 해제
```

### 3. 주문 상태 전이
```
pending → processing → confirmed → shipped → delivered
   ↓          ↓            ↓           ↓
 failed    failed      cancelled   cancelled
```

## 부분 취소/환불
```javascript
{
  _id: ObjectId("..."),
  status: "partially_cancelled",  // 새 상태
  
  items: [
    {
      productId: ObjectId("..."),
      quantity: 2,
      status: "confirmed",  // 정상
    },
    {
      productId: ObjectId("..."),
      quantity: 1,
      status: "cancelled",  // 취소됨
    }
  ],
  
  cancellation: {
    isCancelled: false,  // 전체는 아님
    isPartial: true,
    
    items: [
      {
        productId: ObjectId("..."),
        quantity: 1,
        reason: "고객 요청",
        cancelledBy: "user",
        cancelledAt: ISODate("..."),
        refundAmount: 89.00
      }
    ],
    
    totalRefund: 89.00
  }
}
```