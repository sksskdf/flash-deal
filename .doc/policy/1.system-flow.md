# 재고 감소 플로우

## 기본 플로우 (낙관적)
```
1. 클라이언트: 주문 요청
   └→ GraphQL Mutation: createOrder(productId, quantity)

2. 서버: Redis 재고 확인 및 감소
   ├→ GET inventory:{productId}
   │  └→ if stock >= quantity
   │     ├→ DECRBY inventory:{productId} {quantity}
   │     └→ 성공 → 단계 3
   │  └→ else
   │     └→ 실패 → "품절" 응답

3. 주문 생성 및 예약
   ├→ MongoDB: Order 생성 (status: pending)
   ├→ Redis: 예약 기록
   │  └→ ZADD inventory:reservations:{productId} {expiry} {orderId}
   └→ Kafka: OrderCreated 이벤트 발행

4. 비동기 처리 (Kafka Consumer)
   ├→ 결제 처리
   ├→ 성공 → Order.status = confirmed
   │  └→ MongoDB: Inventory.sold += quantity
   └→ 실패 → 재고 복구
      ├→ INCRBY inventory:{productId} {quantity}
      └→ ZREM inventory:reservations:{productId} {orderId}
```

## 분산 락 플로우 (비관적)
```
1. 락 획득 시도
   └→ SET inventory:lock:{productId} {uuid} NX EX 10
      ├→ 성공 → 단계 2
      └→ 실패 → 재시도 (최대 3회) 또는 에러

2. 재고 확인 및 감소 (락 보호)
   └→ GET inventory:{productId}
      └→ if stock >= quantity
         └→ DECRBY inventory:{productId} {quantity}

3. 주문 생성 (동일)

4. 락 해제
   └→ DEL inventory:lock:{productId} (소유자 확인)
```

# 주문 생성 플로우

## 성공 시나리오
```
1. 클라이언트: createOrder Mutation
   └→ GraphQL Server

2. 주문 검증 및 생성 (동기)
   ├→ 멱등성 키 확인 (중복 방지)
   ├→ 재고 확인 (Redis GET)
   ├→ 주문 생성 (MongoDB, status: pending)
   └→ 응답: { orderId, status: "pending" }

3. 이벤트 발행 (비동기)
   ├→ Kafka: OrderCreated
   └→ Kafka: InventoryReserveRequested

4. Consumer 1: Inventory Service
   ├→ Redis DECR (재고 감소)
   ├→ 성공 → Kafka: InventoryReserved
   └→ 실패 → Kafka: InventoryReserveFailed
      └→ Compensate: Order.status = "failed"

5. Consumer 2: Payment Service
   ├→ 결제 처리 (외부 API)
   ├→ 성공 → Kafka: PaymentCompleted
   │  └→ Order.status = "confirmed"
   │  └→ Kafka: InventoryConfirmed
   └→ 실패 → Kafka: PaymentFailed
      └→ Compensate: 
         ├→ Redis INCR (재고 복구)
         └→ Order.status = "failed"

6. Consumer 3: Notification Service
   ├→ 이메일 발송
   └→ SMS 발송 (선택)
```

## 실패 시나리오 (보상 트랜잭션)

### 재고 부족
```
1. createOrder
2. Redis GET → stock = 0
3. 즉시 응답: { error: "INSUFFICIENT_STOCK" }
   (Kafka 이벤트 발행 안 함)
```

### 결제 실패
```
1-3. 정상 진행
4. Inventory 예약 성공
5. Payment 실패
   └→ Kafka: PaymentFailed
6. Compensating Action
   ├→ Redis INCR (재고 복구)
   ├→ Order.status = "failed"
   └→ Kafka: OrderFailed
```

### Timeout
```
1-3. 정상 진행
4. Inventory 예약 성공 (10분 TTL)
5. Payment 처리 중... (타임아웃)
6. TTL 만료 → Redis 자동 복구
   OR
   Scheduled Job이 만료된 예약 정리
   ├→ ZRANGEBYSCORE (만료된 예약 조회)
   ├→ Redis INCR (재고 복구)
   └→ Order.status = "cancelled"
```

