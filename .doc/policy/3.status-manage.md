# 상태 관리

## 핵심 상태 머신

### 1. 주문 상태
```
pending → processing → confirmed → shipped → delivered
   ↓          ↓            ↓           ↓
 failed    failed      cancelled   cancelled
```

### 2. 재고 상태
```
available → reserved → confirmed → sold
    ↓           ↓          ↓
 soldout    released    (종료)
```

### 3. 결제 상태
```
pending → processing → completed
   ↓          ↓           ↓
 failed    failed     refunded
```

## 상태 전이 규칙

### 주문 상태 전이
```javascript
const orderTransitions = {
  pending: ['processing', 'failed', 'cancelled'],
  processing: ['confirmed', 'failed'],
  confirmed: ['shipped', 'cancelled'],
  shipped: ['delivered', 'cancelled'],
  delivered: [],  // 종료
  failed: [],     // 종료
  cancelled: []   // 종료
};
```

### 재고 레벨 계산
```javascript
function getInventoryLevel(available, total) {
  const ratio = available / total;
  if (ratio >= 0.5) return 'HIGH';
  if (ratio >= 0.2) return 'MID';
  return 'LOW';
}
```

## 상태 변경 처리

### 통합 상태 업데이트
```javascript
async function updateOrderStatus(orderId, newStatus, reason) {
  const order = await db.orders.findOne({ _id: orderId });

  // 상태 전이 검증
  if (!canTransition(order.status, newStatus)) {
    throw new Error(`Invalid transition: ${order.status} → ${newStatus}`);
  }

  // 상태 업데이트 + 이력 기록
  await db.orders.updateOne(
    { _id: orderId },
    {
      $set: { status: newStatus, updatedAt: new Date() },
      $push: {
        statusHistory: {
          from: order.status,
          to: newStatus,
          timestamp: new Date(),
          reason
        }
      }
    }
  );

  // 연관 상태 업데이트
  if (newStatus === 'confirmed') {
    await updatePaymentStatus(order.paymentId, 'completed');
    await updateInventoryStatus(order.items, 'confirmed');
  }

  // 이벤트 발행
  await kafka.send({
    topic: 'orders.updated',
    value: { orderId, oldStatus: order.status, newStatus, reason }
  });
}
```