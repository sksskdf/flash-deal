# Aggregates

```
┌─────────────────┐
│ Product         │ (Root)
└─────────────────┘
        ↑ ID 참조
┌─────────────────┐
│ Inventory       │ (Root)
└─────────────────┘
        ↑ ID 참조
┌─────────────────┐
│ Order           │ (Root)
│ └─ OrderItem[]  │ (Entity)
└─────────────────┘
```


## 1. Product Aggregate
- 상품 정보 관리
- 딜 상태 전이 (upcoming → active → ended)
- 가격 계산

### 구성
```
Product (Root)
├─ ProductId (VO)
├─ Price (VO)
├─ Schedule (VO)
├─ DealStatus (Enum)
└─ Specs (VO, JSON)
```
#### ProductId, OrderId, InventoryId
```
속성:
- value: String (UUID)

검증:
- null/빈값 불가

메서드:
- generate(): ProductId
```

#### Price (가격)
```
속성:
- original: BigDecimal (정가)
- sale: BigDecimal (할인가)
- currency: String (통화 코드)

검증:
- sale <= original
- original, sale >= 0

메서드:
- discountRate(): int
  → (original - sale) / original × 100
```

#### Schedule (일정)
```
속성:
- startsAt: DateTime (시작 시각)
- endsAt: DateTime (종료 시각)
- timezone: String (시간대)

검증:
- startsAt < endsAt

메서드:
- isActive(now: DateTime): boolean
  → startsAt <= now < endsAt
- hasStarted(now: DateTime): boolean
  → now >= startsAt
```

#### Specs (상품 스펙)
```
속성:
- fields: Map<String, Object> (동적 필드)
  예: { "battery": "30h", "bluetooth": "5.0" }

검증:
- null 불가

메서드:
- get(key: String): Object
- has(key: String): boolean
```

#### DealStatus (Enum)
```
값:
- UPCOMING: 시작 전
- ACTIVE: 진행 중
- SOLDOUT: 품절
- ENDED: 종료

전이 규칙:
- UPCOMING → ACTIVE (시작 시각 도달)
- ACTIVE → SOLDOUT (재고 0)
- ACTIVE → ENDED (종료 시각 도달)
```

## 2. Inventory Aggregate
- 재고 수량 관리
- 과판매 방지
- 예약/확정/해제

### 구성
```
Inventory (Root)
├─ InventoryId (VO)
├─ ProductId (VO) - 참조만!
├─ Stock (VO)
└─ Policy (VO)
```
#### Stock (재고)
```
속성:
- total: int (총 재고)
- reserved: int (예약됨)
- available: int (가용)
- sold: int (판매됨)

불변식:
- total, reserved, available, sold >= 0 (모두 음수 불가)
- total = reserved + available + sold

메서드:
- decrease(quantity: int): Stock
  → available - quantity, reserved + quantity
  
- confirm(quantity: int): Stock
  → reserved - quantity, sold + quantity
  
- release(quantity: int): Stock
  → reserved - quantity, available + quantity
```

#### Policy (재고 정책)
```
역할: 재고 운영 규칙 정의

속성:
- safetyStock: int (안전 재고량)
  → 이하로 떨어지면 "품절 임박" 알림
  → 예: 50 → available < 50이면 "LOW"
  
- reservationTimeout: int (예약 제한 시간, 초)
  → 주문 후 결제까지 허용 시간
  → 예: 600 (10분) → 초과 시 자동 취소
  
- maxPurchasePerUser: int (1인 최대 구매)
  → 독점 방지
  → 예: 5 → 1인당 5개까지만

검증:
- safetyStock >= 0
- reservationTimeout > 0
- maxPurchasePerUser > 0

메서드:
- isLowStock(available: int): boolean
  → available < safetyStock
```

## 3. Order Aggregate
- 주문 생성 및 관리
- 상태 전이
- 금액 계산
- 취소/환불

### 구성
```
Order (Root)
├─ OrderId (VO)
├─ UserId (VO) - 참조
├─ OrderItem[] (Entity)
│   ├─ ProductId (VO) - 참조
│   └─ Snapshot (VO) - 스냅샷!
├─ Pricing (VO)
├─ Shipping (VO)
└─ Payment (VO)
```

#### Pricing (주문 금액)
```
속성:
- subtotal: BigDecimal (상품 금액만)
- shipping: BigDecimal (배송비)
- discount: BigDecimal (할인)
- total: BigDecimal (최종 결제 금액)
- currency: String (통화)

불변식:
- total = subtotal + shipping - discount
- subtotal, shipping, discount >= 0

메서드:
- calculate(items, shipping, discount): Pricing
  → subtotal = Σ(item.subtotal)
  → total = subtotal + shipping - discount
```

#### Snapshot (주문 스냅샷)
```
역할: 주문 시점 상품 정보 보존 (Product 변경돼도 유지)

속성:
- title: String (상품명)
- image: String (이미지 URL)
- price: Price (주문 시점 가격)
- selectedOptions: Map<String, Object> (선택 옵션, 동적)

메서드:
- from(product: Product, options: Map): Snapshot
```

#### Shipping (배송 정보)
```
속성:
- method: String (배송 방법)
- recipient: Recipient (VO, 수령인)
- address: Address (VO, 주소)
- instructions: String (요청사항)

검증:
- method 필수
- recipient 필수
- address 필수
```

#### Recipient (수령인)
```
속성:
- name: String (이름)
- phone: String (전화번호)

검증:
- name 필수
- phone 형식 (+82-10-xxxx-xxxx)
```

#### Address (주소)
```
속성:
- street: String (도로명)
- city: String (도시)
- zipCode: String (우편번호)
- country: String (국가 코드)

검증:
- 모든 필드 필수
- zipCode 형식 검증
- country 2자리 코드 (KR, US...)
```

#### Payment (결제 정보)
```
속성:
- method: String (결제 수단)
- status: PaymentStatus (결제 상태)
- transactionId: String (트랜잭션 ID)
- gateway: String (게이트웨이)

검증:
- method 필수
- status가 completed일 때 transactionId 필수
```

#### UserId (사용자 식별자)
```
속성:
- value: String

검증:
- null/빈값 불가
```